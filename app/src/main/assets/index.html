<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé≠ Mafia Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            margin: 20px 0;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .hidden {
            display: none !important;
        }

        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        .auth-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #667eea;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        /* –õ–æ–±–±–∏ */
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .room-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .room-card:hover {
            transform: translateY(-5px);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .room-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .room-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-waiting {
            background: #27ae60;
            color: white;
        }

        .status-playing {
            background: #e74c3c;
            color: white;
        }

        .room-info {
            margin-bottom: 15px;
        }

        .room-players {
            color: #666;
            margin-bottom: 5px;
        }

        .room-creator {
            color: #667eea;
            font-weight: bold;
        }

        /* –ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞ */
        .game-room {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            height: 80vh;
        }

        .game-main {
            display: flex;
            flex-direction: column;
        }

        .game-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .game-phase {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .game-timer {
            font-size: 2em;
            font-weight: bold;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            flex: 1;
            margin-bottom: 20px;
        }

        .player-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .player-card:hover {
            transform: scale(1.05);
        }

        .player-card.dead {
            opacity: 0.5;
            background: #f8f9fa;
        }

        .player-card.selected {
            border: 3px solid #667eea;
            background: #e8f0fe;
        }

        .player-avatar {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .player-nickname {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .player-role {
            font-size: 0.8em;
            color: #666;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .player-status {
            margin-top: 5px;
            font-size: 0.8em;
        }

        .status-alive {
            color: #27ae60;
        }

        .status-dead {
            color: #e74c3c;
        }

        /* –ß–∞—Ç */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            max-height: 400px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .message.system {
            background: #e3f2fd;
            color: #1976d2;
            font-style: italic;
        }

        .message-sender {
            font-weight: bold;
            color: #667eea;
            margin-right: 8px;
        }

        .message-time {
            font-size: 0.8em;
            color: #999;
            float: right;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .chat-input input:focus {
            border-color: #667eea;
            outline: none;
        }

        /* –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        .user-profile {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .user-avatar {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .user-nickname {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .user-coins {
            font-size: 1.2em;
            color: #f39c12;
            margin-bottom: 10px;
        }

        .user-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.8em;
            color: #666;
        }

        /* –ú–∞–≥–∞–∑–∏–Ω */
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .shop-item-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #667eea;
        }

        .shop-item-price {
            color: #f39c12;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .shop-item-preview {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç—ã –Ω–∏–∫–Ω–µ–π–º–∞ */
        .nickname-rainbow {
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow 2s ease-in-out infinite;
        }

        .nickname-glow {
            text-shadow: 0 0 10px #667eea, 0 0 20px #667eea, 0 0 30px #667eea;
            animation: glow 2s ease-in-out infinite alternate;
        }

        .nickname-shake {
            animation: shake 0.5s ease-in-out infinite;
        }

        .nickname-bounce {
            animation: bounce 1s ease-in-out infinite;
        }

        .nickname-fade {
            animation: fade 2s ease-in-out infinite;
        }

        /* –ù–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∏–∫–Ω–µ–π–º–∞ */
        .nickname-fire {
            background: linear-gradient(45deg, #ff4500, #ff6347, #ffa500, #ff4500);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: fire 1.5s ease-in-out infinite;
            text-shadow: 0 0 10px #ff4500;
        }

        .nickname-ice {
            background: linear-gradient(45deg, #00bfff, #87ceeb, #b0e0e6, #00bfff);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: ice 2s ease-in-out infinite;
            text-shadow: 0 0 15px #00bfff;
        }

        .nickname-electric {
            color: #ffff00;
            text-shadow: 0 0 5px #ffff00, 0 0 10px #ffff00, 0 0 15px #ffff00, 0 0 20px #ffff00;
            animation: electric 0.1s ease-in-out infinite;
        }

        .nickname-matrix {
            color: #00ff00;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 10px #00ff00;
            animation: matrix 3s linear infinite;
        }

        .nickname-neon {
            color: #ff00ff;
            text-shadow: 
                0 0 5px #ff00ff,
                0 0 10px #ff00ff,
                0 0 15px #ff00ff,
                0 0 20px #ff00ff,
                0 0 35px #ff00ff,
                0 0 40px #ff00ff;
            animation: neon 1.5s ease-in-out infinite alternate;
        }

        .nickname-gold {
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700, #b8860b);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gold 2s ease-in-out infinite;
            text-shadow: 0 0 10px #ffd700;
        }

        .nickname-shadow {
            color: #333;
            text-shadow: 
                2px 2px 0px #666,
                4px 4px 0px #999,
                6px 6px 0px #ccc;
            animation: shadow 2s ease-in-out infinite;
        }

        .nickname-wave {
            animation: wave 2s ease-in-out infinite;
        }

        .nickname-flip {
            animation: flip 3s ease-in-out infinite;
        }

        .nickname-zoom {
            animation: zoom 2s ease-in-out infinite;
        }

        /* –§–æ–Ω–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã */
        .background-stars {
            position: relative;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: stars 20s linear infinite;
        }

        .background-gradient {
            background: linear-gradient(45deg, #667eea, #764ba2, #667eea, #764ba2);
            background-size: 400% 400%;
            animation: gradientShift 5s ease infinite;
        }

        .background-pulse {
            animation: backgroundPulse 3s ease-in-out infinite;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fire {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes ice {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes electric {
            0%, 100% { text-shadow: 0 0 5px #ffff00, 0 0 10px #ffff00; }
            50% { text-shadow: 0 0 10px #ffff00, 0 0 20px #ffff00, 0 0 30px #ffff00; }
        }

        @keyframes matrix {
            0% { color: #00ff00; }
            25% { color: #00cc00; }
            50% { color: #009900; }
            75% { color: #00cc00; }
            100% { color: #00ff00; }
        }

        @keyframes neon {
            from { 
                text-shadow: 
                    0 0 5px #ff00ff,
                    0 0 10px #ff00ff,
                    0 0 15px #ff00ff,
                    0 0 20px #ff00ff;
            }
            to { 
                text-shadow: 
                    0 0 10px #ff00ff,
                    0 0 20px #ff00ff,
                    0 0 30px #ff00ff,
                    0 0 40px #ff00ff,
                    0 0 50px #ff00ff;
            }
        }

        @keyframes gold {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes shadow {
            0%, 100% { 
                text-shadow: 
                    2px 2px 0px #666,
                    4px 4px 0px #999,
                    6px 6px 0px #ccc;
            }
            50% { 
                text-shadow: 
                    4px 4px 0px #666,
                    8px 8px 0px #999,
                    12px 12px 0px #ccc;
            }
        }

        @keyframes wave {
            0%, 100% { transform: translateY(0px); }
            25% { transform: translateY(-5px); }
            50% { transform: translateY(0px); }
            75% { transform: translateY(5px); }
        }

        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(360deg); }
        }

        @keyframes zoom {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes stars {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes backgroundPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –º–µ–Ω—é */
        .admin-controls {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .admin-controls h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.1em;
            word-wrap: break-word;
        }

        .admin-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .admin-input input, .admin-input select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .admin-input button {
            padding: 8px 15px;
            font-size: 0.9em;
        }

        @media (min-width: 768px) {
            .admin-input {
                flex-direction: row;
                align-items: center;
            }
            
            .admin-input input, .admin-input select {
                flex: 1;
            }
            
            .admin-input button {
                flex: 0 0 auto;
                white-space: nowrap;
            }
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.error {
            background: #e74c3c;
        }

        .notification.warning {
            background: #f39c12;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .game-room {
                grid-template-columns: 1fr;
                height: auto;
            }

            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .header h1 {
                font-size: 2em;
            }

            .container {
                padding: 10px;
            }
        }

        /* –ê–¥–º–∏–Ω—Å–∫–∏–µ —Å—Ç–∏–ª–∏ */
        .admin-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≠ Mafia Game</h1>
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –∏–Ω—Ç—Ä–∏–≥ –∏ –æ–±–º–∞–Ω–∞</p>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="authScreen" class="card">
            <div class="auth-form">
                <h2 style="text-align: center; color: #667eea; margin-bottom: 30px;">–í—Ö–æ–¥ –≤ –∏–≥—Ä—É</h2>
                
                <div id="loginForm">
                    <div class="form-group">
                        <label for="loginNickname">–ù–∏–∫–Ω–µ–π–º:</label>
                        <input type="text" id="loginNickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    </div>
                    <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
                    <button class="btn btn-secondary" onclick="showRegisterForm()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>

                <div id="registerForm" class="hidden">
                    <div class="form-group">
                        <label for="registerNickname">–ù–∏–∫–Ω–µ–π–º:</label>
                        <input type="text" id="registerNickname" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º (3-20 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="registerPassword" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞)">
                    </div>
                    <div class="form-group">
                        <label for="registerAvatar">–ê–≤–∞—Ç–∞—Ä:</label>
                        <input type="text" id="registerAvatar" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: üòé)" maxlength="2">
                    </div>
                    <div class="form-group">
                        <label for="avatarFile">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
                        <input type="file" id="avatarFile" accept="image/*">
                    </div>
                    <button class="btn" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    <button class="btn btn-secondary" onclick="showLoginForm()">–ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É</button>
                </div>
            </div>
        </div>

        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="mainMenu" class="hidden">
            <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">üë§</div>
                <div class="user-nickname" id="userNickname">–ò–≥—Ä–æ–∫</div>
                <div class="user-coins" id="userCoins">üí∞ 0 –º–æ–Ω–µ—Ç</div>
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="userGamesPlayed">0</div>
                        <div class="stat-label">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="userGamesWon">0</div>
                        <div class="stat-label">–ü–æ–±–µ–¥</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="showShop()">üõí –ú–∞–≥–∞–∑–∏–Ω</button>
                    <button class="btn btn-secondary" onclick="showSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    <button class="btn btn-danger" onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>

            <!-- –ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è Anubis -->
            <div id="adminControls" class="admin-controls hidden">
                <h3>üëë –ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ª–Ω–æ–º–æ—á–∏—è Anubis</h3>
                <div class="admin-input">
                    <input type="text" id="adminTargetUser" placeholder="–ù–∏–∫–Ω–µ–π–º –∏–≥—Ä–æ–∫–∞">
                    <input type="number" id="adminCoinsAmount" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç">
                    <button class="btn btn-success" onclick="adminGiveCoins()">–í—ã–¥–∞—Ç—å –º–æ–Ω–µ—Ç—ã</button>
                </div>
                <div class="admin-input">
                    <input type="text" id="adminEffectUser" placeholder="–ù–∏–∫–Ω–µ–π–º –∏–≥—Ä–æ–∫–∞">
                    <select id="adminEffectType">
                        <option value="rainbow">üåà –†–∞–¥—É–≥–∞</option>
                        <option value="glow">‚ú® –°–≤–µ—á–µ–Ω–∏–µ</option>
                        <option value="shake">üì≥ –¢—Ä—è—Å–∫–∞</option>
                        <option value="bounce">‚¨ÜÔ∏è –ü–æ–¥–ø—Ä—ã–≥–∏–≤–∞–Ω–∏–µ</option>
                        <option value="fade">üëª –ó–∞—Ç—É—Ö–∞–Ω–∏–µ</option>
                        <option value="fire">üî• –û–≥–æ–Ω—å</option>
                        <option value="ice">‚ùÑÔ∏è –õ—ë–¥</option>
                        <option value="electric">‚ö° –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ</option>
                        <option value="matrix">üî¢ –ú–∞—Ç—Ä–∏—Ü–∞</option>
                        <option value="neon">üíú –ù–µ–æ–Ω</option>
                        <option value="gold">üëë –ó–æ–ª–æ—Ç–æ</option>
                        <option value="shadow">üåë –¢–µ–Ω—å</option>
                        <option value="wave">üåä –í–æ–ª–Ω–∞</option>
                        <option value="flip">üîÑ –ü–µ—Ä–µ–≤–æ—Ä–æ—Ç</option>
                        <option value="zoom">üîç –£–≤–µ–ª–∏—á–µ–Ω–∏–µ</option>
                        <option value="bg_stars">‚≠ê –ó–≤—ë–∑–¥–Ω—ã–π —Ñ–æ–Ω</option>
                        <option value="bg_gradient">üåà –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω</option>
                        <option value="bg_pulse">üíì –ü—É–ª—å—Å–∏—Ä—É—é—â–∏–π —Ñ–æ–Ω</option>
                    </select>
                    <button class="btn btn-success" onclick="adminGiveEffect()">–í—ã–¥–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç</button>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üè† –ò–≥—Ä–æ–≤—ã–µ –∫–æ–º–Ω–∞—Ç—ã</h2>
                    <button class="btn" onclick="showCreateRoomForm()">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                </div>
                <div id="roomsList" class="rooms-grid">
                    <!-- –ö–æ–º–Ω–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã -->
        <div id="createRoomForm" class="card hidden">
            <h2 style="color: #667eea; margin-bottom: 20px;">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã</h2>
            <div class="form-group">
                <label for="roomName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:</label>
                <input type="text" id="roomName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" maxlength="30">
            </div>
            <div class="form-group">
                <label for="roomPassword">–ü–∞—Ä–æ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                <input type="password" id="roomPassword" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–æ–π –∫–æ–º–Ω–∞—Ç—ã">
            </div>
            <div class="form-group">
                <label for="minPlayers">–ú–∏–Ω–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤:</label>
                <select id="minPlayers">
                    <option value="4">4 –∏–≥—Ä–æ–∫–∞</option>
                    <option value="5">5 –∏–≥—Ä–æ–∫–æ–≤</option>
                    <option value="6">6 –∏–≥—Ä–æ–∫–æ–≤</option>
                </select>
            </div>
            <div class="form-group">
                <label for="maxPlayers">–ú–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤:</label>
                <select id="maxPlayers">
                    <option value="8">8 –∏–≥—Ä–æ–∫–æ–≤</option>
                    <option value="10" selected>10 –∏–≥—Ä–æ–∫–æ–≤</option>
                    <option value="12">12 –∏–≥—Ä–æ–∫–æ–≤</option>
                </select>
            </div>
            <div class="form-group">
                <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–æ–ª–∏:</label>
                <div style="margin-top: 10px;">
                    <label style="display: flex; align-items: center; margin-bottom: 5px;">
                        <input type="checkbox" id="doctorRole" checked style="margin-right: 10px;">
                        üë®‚Äç‚öïÔ∏è –î–æ–∫—Ç–æ—Ä
                    </label>
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" id="loversRole" style="margin-right: 10px;">
                        üíï –í–ª—é–±–ª—ë–Ω–Ω—ã–µ
                    </label>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                <button class="btn btn-secondary" onclick="hideCreateRoomForm()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <!-- –ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞ -->
        <div id="gameRoom" class="hidden">
            <div class="game-room">
                <div class="game-main">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä—ã -->
                    <div class="game-header">
                        <div class="game-phase" id="gamePhase">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
                        <div class="game-timer" id="gameTimer">--:--</div>
                        <div id="gameRole" style="margin-top: 10px; font-size: 1.2em;"></div>
                    </div>

                    <!-- –°–µ—Ç–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ -->
                    <div class="players-grid" id="playersGrid">
                        <!-- –ò–≥—Ä–æ–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>

                    <!-- –ò–≥—Ä–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                    <div id="gameActions" class="card hidden">
                        <h3 id="actionTitle">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</h3>
                        <div id="actionButtons" style="display: flex; gap: 10px; margin-top: 15px;">
                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                    </div>
                </div>

                <!-- –ß–∞—Ç -->
                <div class="chat-container">
                    <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                        <h3 style="margin-bottom: 15px; color: #667eea;">üí¨ –ß–∞—Ç</h3>
                        <div class="chat-messages" id="chatMessages">
                            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        </div>
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="200">
                            <button class="btn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
                    <button class="btn btn-danger" onclick="leaveRoom()" style="margin-top: 15px;">üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                </div>
            </div>
        </div>

        <!-- –ú–∞–≥–∞–∑–∏–Ω -->
        <div id="shopScreen" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üõí –ú–∞–≥–∞–∑–∏–Ω —ç—Ñ—Ñ–µ–∫—Ç–æ–≤</h2>
                <button class="btn btn-secondary" onclick="hideShop()">–ù–∞–∑–∞–¥</button>
            </div>
            <div class="shop-items">
                <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
                <div class="shop-item">
                    <div class="shop-item-name">üåà –†–∞–¥—É–∂–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-rainbow">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 50 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('rainbow', 50)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">‚ú® –°–≤–µ—Ç—è—â–∏–π—Å—è –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-glow">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 30 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('glow', 30)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">üì≥ –¢—Ä—è—Å—É—â–∏–π—Å—è –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-shake">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 25 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('shake', 25)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">‚¨ÜÔ∏è –ü–æ–¥–ø—Ä—ã–≥–∏–≤–∞—é—â–∏–π –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-bounce">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 20 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('bounce', 20)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">üëª –ó–∞—Ç—É—Ö–∞—é—â–∏–π –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-fade">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 15 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('fade', 15)">–ö—É–ø–∏—Ç—å</button>
                </div>
                
                <!-- –ù–û–í–´–ï –≠–§–§–ï–ö–¢–´ -->
                <div class="shop-item">
                    <div class="shop-item-name">üî• –û–≥–Ω–µ–Ω–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-fire">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 75 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('fire', 75)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">‚ùÑÔ∏è –õ–µ–¥—è–Ω–æ–π –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-ice">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 70 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('ice', 70)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">‚ö° –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-electric">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 80 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('electric', 80)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">üî¢ –ú–∞—Ç—Ä–∏—á–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-matrix">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 65 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('matrix', 65)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">üíú –ù–µ–æ–Ω–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-neon">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 85 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('neon', 85)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">üëë –ó–æ–ª–æ—Ç–æ–π –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-gold">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 100 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('gold', 100)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">üåë –¢–µ–Ω–µ–≤–æ–π –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-shadow">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 45 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('shadow', 45)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">üåä –í–æ–ª–Ω–æ–≤–æ–π –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-wave">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 40 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('wave', 40)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">üîÑ –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞—é—â–∏–π—Å—è –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-flip">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 55 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('flip', 55)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">üîç –£–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–π—Å—è –Ω–∏–∫–Ω–µ–π–º</div>
                    <div class="shop-item-preview nickname-zoom">–ü—Ä–∏–º–µ—Ä</div>
                    <div class="shop-item-price">üí∞ 35 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('zoom', 35)">–ö—É–ø–∏—Ç—å</button>
                </div>
                
                <!-- –§–û–ù–û–í–´–ï –≠–§–§–ï–ö–¢–´ -->
                <div class="shop-item">
                    <div class="shop-item-name">‚≠ê –ó–≤—ë–∑–¥–Ω—ã–π —Ñ–æ–Ω</div>
                    <div class="shop-item-preview background-stars" style="padding: 10px; border-radius: 5px;">–§–æ–Ω</div>
                    <div class="shop-item-price">üí∞ 120 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('bg_stars', 120)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">üåà –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω</div>
                    <div class="shop-item-preview background-gradient" style="padding: 10px; border-radius: 5px; color: white;">–§–æ–Ω</div>
                    <div class="shop-item-price">üí∞ 100 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('bg_gradient', 100)">–ö—É–ø–∏—Ç—å</button>
                </div>
                <div class="shop-item">
                    <div class="shop-item-name">üíì –ü—É–ª—å—Å–∏—Ä—É—é—â–∏–π —Ñ–æ–Ω</div>
                    <div class="shop-item-preview background-pulse" style="padding: 10px; border-radius: 5px; background: #667eea; color: white;">–§–æ–Ω</div>
                    <div class="shop-item-price">üí∞ 90 –º–æ–Ω–µ—Ç</div>
                    <button class="btn" onclick="buyEffect('bg_pulse', 90)">–ö—É–ø–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let ws = null;
        let currentUser = null;
        let currentRoom = null;
        let selectedPlayer = null;
        let gameState = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10;
        let reconnectInterval = null;
        let isConnecting = false;

        // WebSocket URL - –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä
        const WS_URL = 'wss://gliterrok-2.onrender.com';

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
        function saveUserSession() {
            if (currentUser) {
                const sessionData = {
                    user: currentUser,
                    room: currentRoom,
                    gameState: gameState,
                    timestamp: Date.now()
                };
                localStorage.setItem('mafiaGame_session', JSON.stringify(sessionData));
                console.log('‚úÖ –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
            }
        }

        function loadUserSession() {
            try {
                const savedSession = localStorage.getItem('mafiaGame_session');
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Å—Å–∏—è –Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
                    if (Date.now() - sessionData.timestamp < 24 * 60 * 60 * 1000) {
                        currentUser = sessionData.user;
                        currentRoom = sessionData.room;
                        gameState = sessionData.gameState;
                        console.log('‚úÖ –°–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', currentUser.nickname);
                        return true;
                    } else {
                        localStorage.removeItem('mafiaGame_session');
                    }
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏:', error);
                localStorage.removeItem('mafiaGame_session');
            }
            return false;
        }

        function clearUserSession() {
            localStorage.removeItem('mafiaGame_session');
            console.log('üóëÔ∏è –°–µ—Å—Å–∏—è –æ—á–∏—â–µ–Ω–∞');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
            
            // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é
            if (loadUserSession()) {
                showNotification('–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Å—Å–∏—é...', 'success');
                if (currentRoom) {
                    showGameRoom();
                    updateGameRoom();
                } else {
                    showMainMenu();
                }
            }
            
            connectWebSocket();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(saveUserSession, 30000);
        });

        function setupEventListeners() {
            // –ß–∞—Ç
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // –õ–æ–≥–∏–Ω
            const loginNickname = document.getElementById('loginNickname');
            const loginPassword = document.getElementById('loginPassword');
            
            if (loginNickname) {
                loginNickname.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }

            if (loginPassword) {
                loginPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', function() {
                saveUserSession();
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ —Ñ–æ–∫—É—Å–∞
            window.addEventListener('blur', function() {
                saveUserSession();
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–æ–∫—É—Å–∞
            window.addEventListener('focus', function() {
                if (ws && ws.readyState !== WebSocket.OPEN) {
                    connectWebSocket();
                }
            });
        }

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ WebSocket —Å –∞–≤—Ç–æ—Ä–µ–∫–æ–Ω–µ–∫—Ç–æ–º
        function connectWebSocket() {
            if (isConnecting) {
                console.log('‚è≥ –£–∂–µ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...');
                return;
            }

            isConnecting = true;
            console.log(`üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É (–ø–æ–ø—ã—Ç–∫–∞ ${reconnectAttempts + 1}/${maxReconnectAttempts})`);

            try {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (ws) {
                    ws.close();
                }

                ws = new WebSocket(WS_URL);

                ws.onopen = function() {
                    console.log('‚úÖ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    isConnecting = false;
                    reconnectAttempts = 0;
                    
                    if (reconnectInterval) {
                        clearInterval(reconnectInterval);
                        reconnectInterval = null;
                    }

                    showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');

                    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è, –ø—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                    if (currentUser && currentUser.nickname) {
                        console.log('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–≤—Ö–æ–¥–∞ –¥–ª—è:', currentUser.nickname);
                        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–ª–æ–≥–∏–Ω, –Ω–æ –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                        if (currentRoom) {
                            // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
                            sendWebSocketMessage({
                                type: 'rejoinRoom',
                                roomId: currentRoom.id
                            });
                        }
                    }
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    }
                };

                ws.onclose = function(event) {
                    console.log('‚ùå WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ. –ö–æ–¥:', event.code);
                    isConnecting = false;
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                        console.log(`üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${delay}ms`);
                        
                        showNotification(`–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${Math.ceil(delay/1000)} —Å–µ–∫...`, 'warning');
                        
                        setTimeout(() => {
                            reconnectAttempts++;
                            connectWebSocket();
                        }, delay);
                    } else {
                        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
                        console.log('‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                    }
                };

                ws.onerror = function(error) {
                    console.error('‚ùå WebSocket –æ—à–∏–±–∫–∞:', error);
                    isConnecting = false;
                };

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket:', error);
                isConnecting = false;
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
        function handleWebSocketMessage(data) {
            console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data.type);

            switch (data.type) {
                case 'connected':
                    showNotification(data.message, 'success');
                    break;

                case 'registerSuccess':
                    showNotification(data.message, 'success');
                    showLoginForm();
                    break;

                case 'loginSuccess':
                    currentUser = data.user;
                    saveUserSession();
                    showMainMenu();
                    showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUser.nickname}!`, 'success');
                    break;

                case 'rooms':
                    updateRoomsList(data.rooms);
                    break;

                case 'roomJoined':
                    currentRoom = data.room;
                    saveUserSession();
                    showGameRoom();
                    updateGameRoom();
                    showNotification(`–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ "${currentRoom.name}"`, 'success');
                    break;

                case 'roomUpdated':
                    if (currentRoom) {
                        currentRoom = data.room;
                        saveUserSession();
                        updateGameRoom();
                    }
                    break;

                case 'gameStarted':
                    gameState = {
                        phase: data.phase,
                        day: data.day || 1,
                        timeLeft: data.timeLeft || 60
                    };
                    saveUserSession();
                    updateGameRoom();
                    showNotification('üéÆ –ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!', 'success');
                    break;

                case 'gameUpdated':
                    gameState = data.game;
                    saveUserSession();
                    updateGameRoom();
                    break;

                case 'gameEnded':
                    showNotification(data.result, 'warning');
                    gameState = null;
                    saveUserSession();
                    updateGameRoom();
                    break;

                case 'chatMessage':
                    addChatMessage(data);
                    break;

                case 'effectBought':
                    currentUser.coins = data.coins;
                    currentUser.nickname_effects = data.nickname_effects;
                    saveUserSession();
                    updateUserProfile();
                    showNotification(`‚ú® –≠—Ñ—Ñ–µ–∫—Ç "${data.effect}" –∫—É–ø–ª–µ–Ω!`, 'success');
                    break;

                case 'avatarUpdated':
                    currentUser.avatar = data.avatar;
                    saveUserSession();
                    updateUserProfile();
                    showNotification('üé≠ –ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!', 'success');
                    break;

                case 'adminActionSuccess':
                    showNotification(`üëë ${data.message}`, 'success');
                    break;

                case 'kicked':
                    showNotification(`‚ùå –í—ã –±—ã–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã: ${data.reason}`, 'error');
                    currentRoom = null;
                    gameState = null;
                    saveUserSession();
                    showMainMenu();
                    break;

                case 'error':
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', data.message);
                    showNotification(data.message, 'error');
                    break;

                case 'pong':
                    // –û—Ç–≤–µ—Ç –Ω–∞ ping
                    break;

                default:
                    console.log('‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:', data.type);
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è WebSocket —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function sendWebSocketMessage(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                try {
                    const message = JSON.stringify(data);
                    ws.send(message);
                    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', data.type);
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                }
            } else {
                console.error('‚ùå WebSocket –Ω–µ –≥–æ—Ç–æ–≤. –°–æ—Å—Ç–æ—è–Ω–∏–µ:', ws ? ws.readyState : 'null');
                showNotification('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                if (!isConnecting) {
                    connectWebSocket();
                }
            }
        }

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLoginForm() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function register() {
            const nickname = document.getElementById('registerNickname').value.trim();
            const password = document.getElementById('registerPassword').value;
            const avatar = document.getElementById('registerAvatar').value.trim() || 'üë§';

            if (!nickname || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            if (nickname.length < 3 || nickname.length > 20) {
                showNotification('–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }

            if (password.length < 4) {
                showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞', 'error');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∏–∫–Ω–µ–π–º –Ω–∞ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
            if (!/^[a-zA-Z–∞-—è–ê-–Ø0-9_-]+$/.test(nickname)) {
                showNotification('–ù–∏–∫–Ω–µ–π–º –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _ –∏ -', 'error');
                return;
            }

            console.log('üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', nickname);

            sendWebSocketMessage({
                type: 'register',
                nickname: nickname,
                password: password,
                avatar: avatar
            });
        }

        function login() {
            const nickname = document.getElementById('loginNickname').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!nickname || !password) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }

            console.log('üîë –í—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', nickname);

            sendWebSocketMessage({
                type: 'login',
                nickname: nickname,
                password: password
            });
        }

        function logout() {
            console.log('üö™ –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
            currentUser = null;
            currentRoom = null;
            gameState = null;
            clearUserSession();
            showAuthScreen();
            showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞–º–∏
        function showAuthScreen() {
            hideAllScreens();
            document.getElementById('authScreen').classList.remove('hidden');
        }

        function showMainMenu() {
            hideAllScreens();
            document.getElementById('mainMenu').classList.remove('hidden');
            updateUserProfile();
            loadRooms();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
            if (currentUser && currentUser.is_admin) {
                document.getElementById('adminControls').classList.remove('hidden');
            }
        }

        function showGameRoom() {
            hideAllScreens();
            document.getElementById('gameRoom').classList.remove('hidden');
        }

        function showShop() {
            hideAllScreens();
            document.getElementById('shopScreen').classList.remove('hidden');
        }

        function hideShop() {
            showMainMenu();
        }

        function showSettings() {
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã', 'warning');
        }

        function hideAllScreens() {
            const screens = ['authScreen', 'mainMenu', 'gameRoom', 'shopScreen', 'createRoomForm'];
            screens.forEach(screen => {
                const element = document.getElementById(screen);
                if (element) {
                    element.classList.add('hidden');
                }
            });
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –Ω–∏–∫–Ω–µ–π–º–∞
        function applyNicknameEffects(element, effects) {
            if (!effects || !Array.isArray(effects)) return;
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            element.className = element.className.replace(/nickname-\w+/g, '');
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∏–∫–Ω–µ–π–º–∞
            effects.forEach(effect => {
                if (effect.startsWith('bg_')) {
                    // –§–æ–Ω–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
                    const parentCard = element.closest('.player-card, .user-profile, .room-card');
                    if (parentCard) {
                        parentCard.classList.add(effect.replace('bg_', 'background-'));
                    }
                } else {
                    // –û–±—ã—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∏–∫–Ω–µ–π–º–∞
                    element.classList.add(`nickname-${effect}`);
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateUserProfile() {
            if (!currentUser) return;

            const avatarElement = document.getElementById('userAvatar');
            const nicknameElement = document.getElementById('userNickname');
            const coinsElement = document.getElementById('userCoins');
            const gamesPlayedElement = document.getElementById('userGamesPlayed');
            const gamesWonElement = document.getElementById('userGamesWon');

            if (avatarElement) avatarElement.textContent = currentUser.avatar;
            
            if (nicknameElement) {
                nicknameElement.textContent = currentUser.nickname;
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∏–∫–Ω–µ–π–º–∞
                applyNicknameEffects(nicknameElement, currentUser.nickname_effects);

                // –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—Å–∫–∏–π –±–µ–π–¥–∂
                if (currentUser.is_admin) {
                    nicknameElement.innerHTML += '<span class="admin-badge">üëë –ë–û–ì</span>';
                }
            }

            if (coinsElement) coinsElement.textContent = `üí∞ ${currentUser.coins} –º–æ–Ω–µ—Ç`;
            if (gamesPlayedElement) gamesPlayedElement.textContent = currentUser.games_played || 0;
            if (gamesWonElement) gamesWonElement.textContent = currentUser.games_won || 0;
        }

        // –ö–æ–º–Ω–∞—Ç—ã
        function loadRooms() {
            sendWebSocketMessage({ type: 'getRooms' });
        }

        function updateRoomsList(rooms) {
            const roomsList = document.getElementById('roomsList');
            if (!roomsList) return;

            roomsList.innerHTML = '';

            if (rooms.length === 0) {
                roomsList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üè†</div>
                        <h3>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</h3>
                        <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∫–æ–º–Ω–∞—Ç—É –∏ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É!</p>
                    </div>
                `;
                return;
            }

            rooms.forEach(room => {
                const roomCard = document.createElement('div');
                roomCard.className = 'room-card';
                
                const statusClass = room.status === 'waiting' ? 'status-waiting' : 'status-playing';
                const statusText = room.status === 'waiting' ? 'üü¢ –û–∂–∏–¥–∞–Ω–∏–µ' : 'üî¥ –ò–≥—Ä–∞—é—Ç';
                const joinDisabled = room.status !== 'waiting' ? 'disabled' : '';
                const joinText = room.status === 'waiting' ? 'üö™ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è' : '‚è≥ –ò–≥—Ä–∞ –∏–¥—ë—Ç';

                roomCard.innerHTML = `
                    <div class="room-header">
                        <div class="room-name">üè† ${room.name}</div>
                        <div class="room-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="room-info">
                        <div class="room-players">üë• ${room.players}/${room.maxPlayers} –∏–≥—Ä–æ–∫–æ–≤</div>
                        <div class="room-creator">üëë –°–æ–∑–¥–∞—Ç–µ–ª—å: ${room.creator}</div>
                        ${room.hasPassword ? '<div style="color: #f39c12;">üîí –ü—Ä–∏–≤–∞—Ç–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞</div>' : '<div style="color: #27ae60;">üåê –û—Ç–∫—Ä—ã—Ç–∞—è –∫–æ–º–Ω–∞—Ç–∞</div>'}
                        <div style="color: #666; font-size: 0.9em; margin-top: 5px;">
                            üìÖ ${new Date(room.createdAt).toLocaleString('ru-RU')}
                        </div>
                    </div>
                    <button class="btn" onclick="joinRoom('${room.id}', ${room.hasPassword})" ${joinDisabled}>
                        ${joinText}
                    </button>
                `;
                
                roomsList.appendChild(roomCard);
            });
        }

        function showCreateRoomForm() {
            hideAllScreens();
            document.getElementById('createRoomForm').classList.remove('hidden');
        }

        function hideCreateRoomForm() {
            showMainMenu();
        }

        function createRoom() {
            const name = document.getElementById('roomName').value.trim();
            const password = document.getElementById('roomPassword').value.trim();
            const minPlayers = parseInt(document.getElementById('minPlayers').value);
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
            const doctorRole = document.getElementById('doctorRole').checked;
            const loversRole = document.getElementById('loversRole').checked;

            if (!name) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã', 'error');
                return;
            }

            if (name.length > 30) {
                showNotification('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ', 'error');
                return;
            }

            console.log('üè† –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:', name);

            sendWebSocketMessage({
                type: 'createRoom',
                room: {
                    name: name,
                    password: password || null,
                    minPlayers: minPlayers,
                    maxPlayers: maxPlayers,
                    roles: {
                        doctor: doctorRole,
                        don: true,
                        lovers: loversRole
                    }
                }
            });

            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('roomName').value = '';
            document.getElementById('roomPassword').value = '';
        }

        function joinRoom(roomId, hasPassword) {
            let password = null;
            
            if (hasPassword) {
                password = prompt('üîí –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã:');
                if (password === null) return;
            }

            console.log('üö™ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ:', roomId);

            sendWebSocketMessage({
                type: 'joinRoom',
                roomId: roomId,
                password: password
            });
        }

        function leaveRoom() {
            if (currentRoom) {
                console.log('üö™ –ü–æ–∫–∏–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É:', currentRoom.id);
                sendWebSocketMessage({
                    type: 'leaveRoom'
                });
                currentRoom = null;
                gameState = null;
                saveUserSession();
                showMainMenu();
            }
        }

        // –ò–≥—Ä–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞
        function updateGameRoom() {
            if (!currentRoom) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const phaseElement = document.getElementById('gamePhase');
            const timerElement = document.getElementById('gameTimer');
            const roleElement = document.getElementById('gameRole');

            if (phaseElement) {
                if (currentRoom.status === 'waiting') {
                    phaseElement.textContent = `üè† ${currentRoom.name} - –û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...`;
                } else if (gameState) {
                    const phaseNames = {
                        'night': 'üåô –ù–æ—á—å',
                        'day': '‚òÄÔ∏è –î–µ–Ω—å'
                    };
                    phaseElement.textContent = `${phaseNames[gameState.phase] || gameState.phase} - –î–µ–Ω—å ${gameState.day}`;
                }
            }

            if (timerElement) {
                if (gameState && gameState.timeLeft !== undefined) {
                    const minutes = Math.floor(gameState.timeLeft / 60);
                    const seconds = gameState.timeLeft % 60;
                    timerElement.textContent = `‚è∞ ${minutes}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    timerElement.textContent = '';
                }
            }

            if (roleElement) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–æ–ª—å –∏–≥—Ä–æ–∫–∞
                const myPlayer = currentRoom.players.find(p => p.nickname === currentUser.nickname);
                if (myPlayer && myPlayer.role) {
                    const roleNames = {
                        'citizen': 'üë®‚Äçüíº –ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å',
                        'mafia': 'üî´ –ú–∞—Ñ–∏—è',
                        'don': 'üëë –î–æ–Ω –º–∞—Ñ–∏–∏',
                        'doctor': 'üë®‚Äç‚öïÔ∏è –î–æ–∫—Ç–æ—Ä',
                        'lover1': 'üíï –í–ª—é–±–ª—ë–Ω–Ω—ã–π',
                        'lover2': 'üíï –í–ª—é–±–ª—ë–Ω–Ω–∞—è'
                    };
                    roleElement.textContent = `üé≠ –í–∞—à–∞ —Ä–æ–ª—å: ${roleNames[myPlayer.role] || myPlayer.role}`;
                } else {
                    roleElement.textContent = '';
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ç–∫—É –∏–≥—Ä–æ–∫–æ–≤
            updatePlayersGrid();

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
            updateGameActions();
        }

        function updatePlayersGrid() {
            const grid = document.getElementById('playersGrid');
            if (!grid || !currentRoom || !currentRoom.players) return;

            grid.innerHTML = '';

            currentRoom.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                
                if (!player.isAlive) {
                    playerCard.classList.add('dead');
                }

                if (selectedPlayer === player.nickname) {
                    playerCard.classList.add('selected');
                }

                const adminBadge = player.nickname === 'Anubis' ? ' <span class="admin-badge">–ë–û–ì</span>' : '';
                const creatorBadge = player.isCreator ? ' üëë' : '';
                const roleDisplay = player.role ? `<div class="player-role">${getRoleName(player.role)}</div>` : '';

                playerCard.innerHTML = `
                    <div class="player-avatar">${player.avatar}</div>
                    <div class="player-nickname" data-nickname="${player.nickname}">
                        ${player.nickname}${creatorBadge}${adminBadge}
                    </div>
                    ${roleDisplay}
                    <div class="player-status ${player.isAlive ? 'status-alive' : 'status-dead'}">
                        ${player.isAlive ? '‚úÖ –ñ–∏–≤' : 'üíÄ –ú—ë—Ä—Ç–≤'}
                    </div>
                `;

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∏–∫–Ω–µ–π–º–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const nicknameElement = playerCard.querySelector('.player-nickname');
                if (player.nickname === currentUser.nickname && currentUser.nickname_effects) {
                    applyNicknameEffects(nicknameElement, currentUser.nickname_effects);
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–∏
                if (gameState && player.isAlive && player.nickname !== currentUser.nickname) {
                    playerCard.style.cursor = 'pointer';
                    playerCard.onclick = () => selectPlayer(player.nickname);
                }

                grid.appendChild(playerCard);
            });
        }

        function getRoleName(role) {
            const roleNames = {
                'citizen': 'üë®‚Äçüíº –ú–∏—Ä–Ω—ã–π',
                'mafia': 'üî´ –ú–∞—Ñ–∏—è',
                'don': 'üëë –î–æ–Ω',
                'doctor': 'üë®‚Äç‚öïÔ∏è –î–æ–∫—Ç–æ—Ä',
                'lover1': 'üíï –í–ª—é–±–ª—ë–Ω–Ω—ã–π',
                'lover2': 'üíï –í–ª—é–±–ª—ë–Ω–Ω–∞—è'
            };
            return roleNames[role] || role;
        }

        function selectPlayer(nickname) {
            selectedPlayer = nickname;
            updatePlayersGrid();
            showNotification(`–í—ã–±—Ä–∞–Ω –∏–≥—Ä–æ–∫: ${nickname}`, 'success');
        }

        function updateGameActions() {
            const actionsDiv = document.getElementById('gameActions');
            const titleElement = document.getElementById('actionTitle');
            const buttonsDiv = document.getElementById('actionButtons');

            if (!actionsDiv || !titleElement || !buttonsDiv) return;

            if (!gameState || currentRoom.status !== 'playing') {
                actionsDiv.classList.add('hidden');
                return;
            }

            const myPlayer = currentRoom.players.find(p => p.nickname === currentUser.nickname);
            if (!myPlayer || !myPlayer.isAlive) {
                actionsDiv.classList.add('hidden');
                return;
            }

            actionsDiv.classList.remove('hidden');
            buttonsDiv.innerHTML = '';

            if (gameState.phase === 'night') {
                if (myPlayer.role === 'mafia' || myPlayer.role === 'don') {
                    titleElement.textContent = 'üî´ –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –¥–ª—è —É–±–∏–π—Å—Ç–≤–∞';
                    const killBtn = document.createElement('button');
                    killBtn.className = 'btn btn-danger';
                    killBtn.textContent = 'üî´ –£–±–∏—Ç—å';
                    killBtn.onclick = () => performAction('kill');
                    buttonsDiv.appendChild(killBtn);
                } else if (myPlayer.role === 'doctor') {
                    titleElement.textContent = 'üíä –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–≥–æ –ª–µ—á–∏—Ç—å';
                    const healBtn = document.createElement('button');
                    healBtn.className = 'btn btn-success';
                    healBtn.textContent = 'üíä –õ–µ—á–∏—Ç—å';
                    healBtn.onclick = () => performAction('heal');
                    buttonsDiv.appendChild(healBtn);
                } else {
                    titleElement.textContent = 'üåô –ù–æ—á—å... –°–ø–∏—Ç–µ —Å–ø–æ–∫–æ–π–Ω–æ';
                }
            } else if (gameState.phase === 'day') {
                titleElement.textContent = 'üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ';
                const voteBtn = document.createElement('button');
                voteBtn.className = 'btn';
                voteBtn.textContent = 'üó≥Ô∏è –ì–æ–ª–æ—Å–æ–≤–∞—Ç—å';
                voteBtn.onclick = () => performAction('vote');
                buttonsDiv.appendChild(voteBtn);

                const skipBtn = document.createElement('button');
                skipBtn.className = 'btn btn-secondary';
                skipBtn.textContent = '‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≥–æ–ª–æ—Å';
                skipBtn.onclick = () => performAction('skip');
                buttonsDiv.appendChild(skipBtn);
            }
        }

        function performAction(action) {
            if (!selectedPlayer && action !== 'skip') {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è', 'error');
                return;
            }

            console.log('üéÆ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:', action, '—Ü–µ–ª—å:', selectedPlayer);

            sendWebSocketMessage({
                type: 'gameAction',
                action: {
                    action: action,
                    target: selectedPlayer
                }
            });

            selectedPlayer = null;
            updatePlayersGrid();
            showNotification(`‚úÖ –î–µ–π—Å—Ç–≤–∏–µ "${action}" –≤—ã–ø–æ–ª–Ω–µ–Ω–æ`, 'success');
        }

        // –£–ª—É—á—à–µ–Ω–Ω—ã–π —á–∞—Ç
        function sendMessage() {
            const input = document.getElementById('chatInput');
            if (!input) return;

            const message = input.value.trim();

            if (!message) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', 'warning');
                return;
            }

            if (message.length > 200) {
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤)', 'error');
                return;
            }

            if (!currentRoom) {
                showNotification('–í—ã –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –∫–æ–º–Ω–∞—Ç–µ', 'error');
                return;
            }

            console.log('üí¨ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', message);

            sendWebSocketMessage({
                type: 'chatMessage',
                message: message
            });

            input.value = '';
        }

        function addChatMessage(data) {
            const messagesDiv = document.getElementById('chatMessages');
            if (!messagesDiv) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            if (data.sender === '–°–∏—Å—Ç–µ–º–∞') {
                messageDiv.classList.add('system');
            }

            const time = new Date(data.timestamp).toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const senderDisplay = data.sender === '–°–∏—Å—Ç–µ–º–∞' ? 'ü§ñ –°–∏—Å—Ç–µ–º–∞' : `üë§ ${data.sender}`;

            messageDiv.innerHTML = `
                <span class="message-sender">${senderDisplay}:</span>
                <span class="message-text">${data.message}</span>
                <span class="message-time">${time}</span>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
            while (messagesDiv.children.length > 100) {
                messagesDiv.removeChild(messagesDiv.firstChild);
            }

            console.log('üí¨ –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:', data.sender);
        }

        // –ú–∞–≥–∞–∑–∏–Ω
        function buyEffect(effect, price) {
            if (!currentUser) {
                showNotification('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã', 'error');
                return;
            }

            if (currentUser.coins < price) {
                showNotification(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç. –ù—É–∂–Ω–æ: ${price}, —É –≤–∞—Å: ${currentUser.coins}`, 'error');
                return;
            }

            if (currentUser.nickname_effects && currentUser.nickname_effects.includes(effect)) {
                showNotification('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å —ç—Ç–æ—Ç —ç—Ñ—Ñ–µ–∫—Ç', 'warning');
                return;
            }

            console.log('üõí –ü–æ–∫—É–ø–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞:', effect, '–∑–∞', price, '–º–æ–Ω–µ—Ç');

            sendWebSocketMessage({
                type: 'buyEffect',
                effect: effect
            });
        }

        // –ê–¥–º–∏–Ω—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function adminGiveCoins() {
            const targetUser = document.getElementById('adminTargetUser').value.trim();
            const amount = parseInt(document.getElementById('adminCoinsAmount').value);

            if (!targetUser || !amount) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            console.log('üëë –ê–¥–º–∏–Ω –≤—ã–¥–∞—á–∞ –º–æ–Ω–µ—Ç:', targetUser, amount);

            sendWebSocketMessage({
                type: 'adminAction',
                action: 'giveCoins',
                target: targetUser,
                amount: amount
            });

            document.getElementById('adminTargetUser').value = '';
            document.getElementById('adminCoinsAmount').value = '';
        }

        function adminGiveEffect() {
            const targetUser = document.getElementById('adminEffectUser').value.trim();
            const effect = document.getElementById('adminEffectType').value;

            if (!targetUser || !effect) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            console.log('üëë –ê–¥–º–∏–Ω –≤—ã–¥–∞—á–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞:', targetUser, effect);

            sendWebSocketMessage({
                type: 'adminAction',
                action: 'giveEffect',
                target: targetUser,
                effect: effect
            });

            document.getElementById('adminEffectUser').value = '';
        }

        // –£–ª—É—á—à–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, type = 'success') {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–≥–æ –∂–µ —Ç–∏–ø–∞
            const existingNotifications = document.querySelectorAll(`.notification.${type}`);
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };

            notification.innerHTML = `
                <span style="margin-right: 8px;">${icons[type] || 'üì¢'}</span>
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);

            // –£–¥–∞–ª—è–µ–º –ø–æ –∫–ª–∏–∫—É
            notification.onclick = () => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            };

            console.log(`üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (${type}):`, message);
        }

        // Ping –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                sendWebSocketMessage({ type: 'ping' });
            }
        }, 30000);

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –∏–≥—Ä—ã
        setInterval(() => {
            if (gameState && gameState.timeLeft > 0) {
                gameState.timeLeft--;
                updateGameRoom();
            }
        }, 1000);

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (currentUser && !currentRoom && document.getElementById('mainMenu') && !document.getElementById('mainMenu').classList.contains('hidden')) {
                loadRooms();
            }
        }, 10000);

        console.log('üéÆ Mafia Game –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
    </script>
</body>
</html>
